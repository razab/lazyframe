(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
  typeof define === 'function' && define.amd ? define(factory) :
  (global.lazyframe = factory());
}(this, (function () { 'use strict';

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var Lazyframe = function Lazyframe() {

  var settings = void 0;

  var elements = [];

  var defaults = {
    vendor: undefined,
    id: undefined,
    src: undefined,
    thumbnail: undefined,
    title: undefined,
    apikey: undefined,
    initialized: false,
    parameters: undefined,
    y: undefined,
    debounce: 250,
    lazyload: true,
    initinview: false,
    onLoad: function onLoad(l) {},
    onAppend: function onAppend(l) {},
    onThumbnailLoad: function onThumbnailLoad(img) {}
  };

  var constants = {
    regex: {
      youtube: /(?:youtube\.com\/\S*(?:(?:\/e(?:mbed))?\/|watch\?(?:\S*?&?v\=))|youtu\.be\/)([a-zA-Z0-9_-]{6,11})/,
      "youtube-playlist": /(?:youtube\.com\/\S*(?:(?:\/e(?:mbed))?\/|videoseries\?(?:\S*?&?list\=)))([a-zA-Z0-9_-]{20,34})/,
      vimeo: /vimeo\.com\/(?:video\/)?([0-9]*)(?:\?|)/,
      vine: /vine.co\/v\/(.*)/
    },
    condition: {
      youtube: function youtube(m) {
        return m && m[1].length == 11 ? m[1] : false;
      },
      "youtube-playlist": function youtubePlaylist(m) {
        return m && m[1].length == 34 ? m[1] : false;
      },
      vimeo: function vimeo(m) {
        return m && m[1].length === 9 || m[1].length === 8 ? m[1] : false;
      },
      vine: function vine(m) {
        return m && m[1].length === 11 ? m[1] : false;
      }
    },
    src: {
      youtube: function youtube(s) {
        return "https://www.youtube.com/embed/" + s.id + "/?" + s.parameters;
      },
      "youtube-playlist": function youtubePlaylist(s) {
        return "https://www.youtube.com/embed/videoseries?list=" + s.id + "&" + s.parameters;
      },
      vimeo: function vimeo(s) {
        return "https://player.vimeo.com/video/" + s.id + "/?" + s.parameters;
      },
      vine: function vine(s) {
        return "https://vine.co/v/" + s.id + "/embed/simple";
      }
    },
    endpoints: {
      youtube: function youtube(s) {
        return "https://www.googleapis.com/youtube/v3/videos?id=" + s.id + "&key=" + s.apikey + "&fields=items(snippet(title,thumbnails))&part=snippet";
      },
      "youtube-playlist": function youtubePlaylist(s) {
        return "https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=1&playlistId=" + s.id + "&key=" + s.apikey;
      },
      vimeo: function vimeo(s) {
        return "https://vimeo.com/api/oembed.json?url=https%3A//vimeo.com/" + s.id;
      },
      vine: function vine(s) {
        return "https://vine.co/oembed.json?url=https%3A%2F%2Fvine.co%2Fv%2F" + s.id;
      }
    },
    response: {
      youtube: {
        title: function title(r) {
          return r.items['0'].snippet.title;
        },
        thumbnail: function thumbnail(r) {
          var thumbs = r.items["0"].snippet.thumbnails;
          var thumb = thumbs.maxres || thumbs.standard || thumbs.high || thumbs.medium || thumbs.default;
          return thumb.url;
        }
      },
      "youtube-playlist": {
        title: function title(r) {
          return r.items['0'].snippet.title;
        },
        totalResults: function totalResults(r) {
          return r.pageInfo.totalResults;
        }, //1 per page !
        playlistId: function playlistId(r) {
          return r.items['0'].snippet.playlistId;
        },
        videoId: function videoId(r) {
          return r.items['0'].snippet.resourceId.videoId;
        },
        thumbnail: function thumbnail(r) {
          console.dir(r);
          var thumbs = r.items["0"].snippet.thumbnails;
          var thumb = thumbs.maxres || thumbs.standard || thumbs.high || thumbs.medium || thumbs.default;
          return thumb.url;
        }
      },
      vimeo: {
        title: function title(r) {
          return r.title;
        },
        thumbnail: function thumbnail(r) {
          return r.thumbnail_url;
        }
      },
      vine: {
        title: function title(r) {
          return r.title;
        },
        thumbnail: function thumbnail(r) {
          return r.thumbnail_url;
        }
      }
    }
  };

  function init(elements) {
    settings = _extends({}, defaults, arguments.length <= 1 ? undefined : arguments[1]);

    if (typeof elements === 'string') {

      var selector = document.querySelectorAll(elements);
      for (var i = 0; i < selector.length; i++) {
        loop(selector[i]);
      }
    } else if (typeof elements.length === 'undefined') {
      loop(elements);
    } else if (elements.length > 1) {

      for (var _i = 0; _i < elements.length; _i++) {
        loop(elements[_i]);
      }
    } else {
      loop(elements[0]);
    }

    if (settings.lazyload) {
      scroll();
    }
  }

  function loop(el) {
    var _this = this;

    if (el instanceof HTMLElement === false || el.classList.contains('lazyframe--loaded')) return;

    var lazyframe = {
      el: el,
      settings: setup(el)
    };

    lazyframe.el.addEventListener('click', function () {
      lazyframe.el.appendChild(lazyframe.iframe);

      var iframe = el.querySelectorAll('iframe');
      lazyframe.settings.onAppend.call(_this, iframe[0]);
    });

    if (settings.lazyload) {
      build(lazyframe);
    } else {
      api(lazyframe, !!lazyframe.settings.thumbnail);
    }
  }

  function setup(el) {

    var attr = Array.prototype.slice.apply(el.attributes).filter(function (att) {
      return att.value !== '';
    }).reduce(function (obj, curr) {
      var name = curr.name.indexOf('data-') === 0 ? curr.name.split('data-')[1] : curr.name;
      obj[name] = curr.value;
      return obj;
    }, {});

    var options = _extends({}, settings, attr, {
      y: el.offsetTop,
      parameters: extractParams(attr.src)
    });

    if (options.vendor) {
      var match = options.src.match(constants.regex[options.vendor]);
      options.id = constants.condition[options.vendor](match);
    }

    return options;
  }

  function extractParams(url) {
    var params = url.split('?');

    if (params[1]) {
      params = params[1];
      var hasAutoplay = params.indexOf('autoplay') !== -1;
      return hasAutoplay ? params : params + '&autoplay=1';
    } else {
      return 'autoplay=1';
    }
  }

  function useApi(settings) {

    if (!settings.vendor) return false;

    if (!settings.title || !settings.thumbnail) {
      if (settings.vendor === 'youtube' || settings.vendor === "youtube-playlist") {
        return !!settings.apikey;
      } else {
        return true;
      }
    } else {
      return false;
    }
  }

  function api(lazyframe) {
    var _this2 = this;

    if (useApi(lazyframe.settings)) {
      send(lazyframe, function (err, data) {
        if (err) return;

        var response = data[0];
        var _l = data[1];

        if (!_l.settings.title) {
          _l.settings.title = constants.response[_l.settings.vendor].title(response);
        }
        if (!_l.settings.thumbnail) {
          var url = constants.response[_l.settings.vendor].thumbnail(response);
          _l.settings.thumbnail = url;
          lazyframe.settings.onThumbnailLoad.call(_this2, url);
        }
        if (_l.settings.vendor == "youtube-playlist") {
          _l.settings.videoId = constants.response[_l.settings.vendor].videoId(response);
          _l.settings.playlistId = constants.response[_l.settings.vendor].playlistId(response);
          _l.settings.totalResults = constants.response[_l.settings.vendor].totalResults(response);
        }
        build(_l, true);
      });
    } else {
      build(lazyframe, true);
    }
  }

  function send(lazyframe, cb) {

    var endpoint = constants.endpoints[lazyframe.settings.vendor](lazyframe.settings);
    var request = new XMLHttpRequest();

    request.open('GET', endpoint, true);

    request.onload = function () {
      if (request.status >= 200 && request.status < 400) {
        var data = JSON.parse(request.responseText);
        cb(null, [data, lazyframe]);
      } else {
        cb(true);
      }
    };

    request.onerror = function () {
      cb(true);
    };

    request.send();
  }

  function scroll() {
    var _this3 = this;

    var height = window.innerHeight;
    var count = elements.length;
    var initElement = function initElement(el, i) {
      el.settings.initialized = true;
      el.el.classList.add('lazyframe--loaded');
      count--;
      api(el);

      if (el.settings.initinview) {
        el.el.click();
      }

      el.settings.onLoad.call(_this3, el);
    };

    elements.filter(function (el) {
      return el.settings.y < height;
    }).forEach(initElement);

    var onScroll = debounce(function () {

      up = lastY < window.pageYOffset;
      lastY = window.pageYOffset;

      if (up) {
        elements.filter(function (el) {
          return el.settings.y < height + lastY && el.settings.initialized === false;
        }).forEach(initElement);
      }

      if (count === 0) {
        window.removeEventListener('scroll', onScroll, false);
      }
    }, settings.debounce);

    var lastY = 0;
    var t = false,
        up = false;
    window.addEventListener('scroll', onScroll, false);

    function debounce(func, wait, immediate) {
      var timeout = void 0;
      return function () {
        var context = this,
            args = arguments;
        var later = function later() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
      };
    }
  }

  function build(lazyframe, loadImage) {

    lazyframe.iframe = getIframe(lazyframe.settings);

    if (lazyframe.settings.thumbnail && loadImage) {
      lazyframe.el.style.backgroundImage = "url(" + lazyframe.settings.thumbnail + ")";
    }

    if (lazyframe.settings.title && lazyframe.el.children.length === 0) {
      var docfrag = document.createDocumentFragment(),
          titleNode = document.createElement('span');

      titleNode.className = 'lazyframe__title';

      if (lazyframe.settings.vendor == "youtube-playlist") {
        console.log("creating link element");
        console.dir("settings", lazyframe.settings);
        var titleLink = document.createElement('a');
        titleLink.className = 'lazyframe__title_link';
        titleLink.setAttribute('target', '_blank');
        titleLink.setAttribute('href', "https://www.youtube.com/watch?list=" + lazyframe.settings.playlistId + "&v=" + lazyframe.settings.videoId);
        titleLink.innerText = lazyframe.settings.title;
        titleNode.appendChild(titleLink);
      } else {
        titleNode.innerHTML = lazyframe.settings.title;
      }

      docfrag.appendChild(titleNode);

      lazyframe.el.appendChild(docfrag);
    }

    if (!settings.lazyload) {
      lazyframe.el.classList.add('lazyframe--loaded');
      lazyframe.settings.onLoad.call(this, lazyframe);
      elements.push(lazyframe);
    }

    if (!lazyframe.settings.initialized) {
      elements.push(lazyframe);
    }
  }

  function getIframe(settings) {

    var docfrag = document.createDocumentFragment(),
        iframeNode = document.createElement('iframe');

    if (settings.vendor) {
      settings.src = constants.src[settings.vendor](settings);
    }

    iframeNode.setAttribute('id', "lazyframe-" + settings.id);
    iframeNode.setAttribute('src', settings.src);
    iframeNode.setAttribute('frameborder', 0);
    iframeNode.setAttribute('allowfullscreen', '');

    if (settings.vendor === 'vine') {
      var scriptNode = document.createElement('script');
      scriptNode.setAttribute('src', 'https://platform.vine.co/static/scripts/embed.js');
      docfrag.appendChild(scriptNode);
    }

    docfrag.appendChild(iframeNode);
    return docfrag;
  }

  return init;
};

var lf = Lazyframe();

return lf;

})));
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.lazyframe=e()}(this,function(){"use strict";var t=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t};return function(){function e(e){if(c=t({},m,arguments.length<=1?void 0:arguments[1]),"string"==typeof e)for(var i=document.querySelectorAll(e),s=0;s<i.length;s++)n(i[s]);else if(void 0===e.length)n(e);else if(e.length>1)for(var o=0;o<e.length;o++)n(e[o]);else n(e[0]);c.lazyload&&l()}function n(t){var e=this;if(t instanceof HTMLElement!=!1&&!t.classList.contains("lazyframe--loaded")){var n={el:t,settings:i(t)};n.el.addEventListener("click",function(){n.el.appendChild(n.iframe);var i=t.querySelectorAll("iframe");n.settings.onAppend.call(e,i[0])}),c.lazyload?u(n):r(n,!!n.settings.thumbnail)}}function i(e){var n=Array.prototype.slice.apply(e.attributes).filter(function(t){return""!==t.value}).reduce(function(t,e){return t[0===e.name.indexOf("data-")?e.name.split("data-")[1]:e.name]=e.value,t},{}),i=t({},c,n,{y:e.offsetTop,parameters:s(n.src)});if(i.vendor){var o=i.src.match(f.regex[i.vendor]);i.id=f.condition[i.vendor](o)}return i}function s(t){var e=t.split("?");if(e[1]){e=e[1];return-1!==e.indexOf("autoplay")?e:e+"&autoplay=1"}return"autoplay=1"}function o(t){return!!t.vendor&&((!t.title||!t.thumbnail)&&("youtube"!==t.vendor&&"youtube-playlist"!==t.vendor||!!t.apikey))}function r(t){var e=this;o(t.settings)?a(t,function(n,i){if(!n){var s=i[0],o=i[1];if(o.settings.title||(o.settings.title=f.response[o.settings.vendor].title(s)),!o.settings.thumbnail){var r=f.response[o.settings.vendor].thumbnail(s);o.settings.thumbnail=r,t.settings.onThumbnailLoad.call(e,r)}"youtube-playlist"==o.settings.vendor&&(o.settings.videoId=f.response[o.settings.vendor].videoId(s),o.settings.playlistId=f.response[o.settings.vendor].playlistId(s),o.settings.totalResults=f.response[o.settings.vendor].totalResults(s)),u(o,!0)}}):u(t,!0)}function a(t,e){var n=f.endpoints[t.settings.vendor](t.settings),i=new XMLHttpRequest;i.open("GET",n,!0),i.onload=function(){if(i.status>=200&&i.status<400){var n=JSON.parse(i.responseText);e(null,[n,t])}else e(!0)},i.onerror=function(){e(!0)},i.send()}function l(){var t=this,e=window.innerHeight,n=p.length,i=function(e,i){e.settings.initialized=!0,e.el.classList.add("lazyframe--loaded"),n--,r(e),e.settings.initinview&&e.el.click(),e.settings.onLoad.call(t,e)};p.filter(function(t){return t.settings.y<e}).forEach(i);var s=function(t,e,n){var i=void 0;return function(){var s=this,o=arguments,r=function(){i=null,n||t.apply(s,o)},a=n&&!i;clearTimeout(i),i=setTimeout(r,e),a&&t.apply(s,o)}}(function(){a=o<window.pageYOffset,o=window.pageYOffset,a&&p.filter(function(t){return t.settings.y<e+o&&!1===t.settings.initialized}).forEach(i),0===n&&window.removeEventListener("scroll",s,!1)},c.debounce),o=0,a=!1;window.addEventListener("scroll",s,!1)}function u(t,e){if(t.iframe=d(t.settings),t.settings.thumbnail&&e&&t.settings.title&&0===t.el.children.length){var n=document.createDocumentFragment(),i=document.createElement("div");if(i.className="lazyframe__title","youtube-playlist"==t.settings.vendor){console.log("creating link element"),console.dir("settings",t.settings);var s=document.createElement("div");s.className="lazyframe__title_icon",s.innerHTML="&nbsp;";var o=document.createElement("div");o.className="lazyframe__title_count",o.innerText="1/302";var r=document.createElement("a");r.className="lazyframe__title_link",r.setAttribute("target","_blank"),r.setAttribute("href","https://www.youtube.com/watch?list="+t.settings.playlistId+"&v="+t.settings.videoId),r.innerText=t.settings.title,i.appendChild(s),i.appendChild(o),i.appendChild(r);var a=document.createElement("div");a.className="lazyframe__background",a.style.backgroundImage="url("+t.settings.thumbnail+")",t.el.appendChild(a)}else i.innerHTML=t.settings.title,t.el.style.backgroundImage="url("+t.settings.thumbnail+")";n.appendChild(i),t.el.appendChild(n)}c.lazyload||(t.el.classList.add("lazyframe--loaded"),t.settings.onLoad.call(this,t),p.push(t)),t.settings.initialized||p.push(t)}function d(t){var e=document.createDocumentFragment(),n=document.createElement("iframe");if(t.vendor&&(t.src=f.src[t.vendor](t)),n.setAttribute("id","lazyframe-"+t.id),n.setAttribute("src",t.src),n.setAttribute("frameborder",0),n.setAttribute("allowfullscreen",""),"vine"===t.vendor){var i=document.createElement("script");i.setAttribute("src","https://platform.vine.co/static/scripts/embed.js"),e.appendChild(i)}return e.appendChild(n),e}var c=void 0,p=[],m={vendor:void 0,id:void 0,src:void 0,thumbnail:void 0,title:void 0,apikey:void 0,initialized:!1,parameters:void 0,y:void 0,debounce:250,lazyload:!0,initinview:!1,onLoad:function(t){},onAppend:function(t){},onThumbnailLoad:function(t){}},f={regex:{youtube:/(?:youtube\.com\/\S*(?:(?:\/e(?:mbed))?\/|watch\?(?:\S*?&?v\=))|youtu\.be\/)([a-zA-Z0-9_-]{6,11})/,"youtube-playlist":/(?:youtube\.com\/\S*(?:(?:\/e(?:mbed))?\/|videoseries\?(?:\S*?&?list\=)))([a-zA-Z0-9_-]{20,34})/,vimeo:/vimeo\.com\/(?:video\/)?([0-9]*)(?:\?|)/,vine:/vine.co\/v\/(.*)/},condition:{youtube:function(t){return!(!t||11!=t[1].length)&&t[1]},"youtube-playlist":function(t){return!(!t||34!=t[1].length)&&t[1]},vimeo:function(t){return!!(t&&9===t[1].length||8===t[1].length)&&t[1]},vine:function(t){return!(!t||11!==t[1].length)&&t[1]}},src:{youtube:function(t){return"https://www.youtube.com/embed/"+t.id+"/?"+t.parameters},"youtube-playlist":function(t){return"https://www.youtube.com/embed/videoseries?list="+t.id+"&"+t.parameters},vimeo:function(t){return"https://player.vimeo.com/video/"+t.id+"/?"+t.parameters},vine:function(t){return"https://vine.co/v/"+t.id+"/embed/simple"}},endpoints:{youtube:function(t){return"https://www.googleapis.com/youtube/v3/videos?id="+t.id+"&key="+t.apikey+"&fields=items(snippet(title,thumbnails))&part=snippet"},"youtube-playlist":function(t){return"https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=1&playlistId="+t.id+"&key="+t.apikey},vimeo:function(t){return"https://vimeo.com/api/oembed.json?url=https%3A//vimeo.com/"+t.id},vine:function(t){return"https://vine.co/oembed.json?url=https%3A%2F%2Fvine.co%2Fv%2F"+t.id}},response:{youtube:{title:function(t){return t.items[0].snippet.title},thumbnail:function(t){var e=t.items[0].snippet.thumbnails;return(e.maxres||e.standard||e.high||e.medium||e.default).url}},"youtube-playlist":{title:function(t){return t.items[0].snippet.title},totalResults:function(t){return t.pageInfo.totalResults},playlistId:function(t){return t.items[0].snippet.playlistId},videoId:function(t){return t.items[0].snippet.resourceId.videoId},thumbnail:function(t){console.dir(t);var e=t.items[0].snippet.thumbnails;return(e.maxres||e.standard||e.high||e.medium||e.default).url}},vimeo:{title:function(t){return t.title},thumbnail:function(t){return t.thumbnail_url}},vine:{title:function(t){return t.title},thumbnail:function(t){return t.thumbnail_url}}}};return e}()});
